<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜é›„å¸‚åƒåœ¾è»Šå³æ™‚å®šä½</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map {
            height: 100%;
            width: 100%;
        }

        .custom-truck-icon {
            background: none;
            border: none;
        }

        .refresh-loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* è¨Šæ¯æç¤ºæ¡†æ¨£å¼ */
        #toast-container {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans h-screen flex flex-col overflow-hidden">

    <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center flex-none">
        <div>
            <h1 class="text-xl font-bold flex items-center gap-2">
                ğŸšš é«˜é›„å¸‚åƒåœ¾è»Šå‹•æ…‹
            </h1>
            <p class="text-xs opacity-80">è³‡æ–™ä¾†æºï¼šé«˜é›„å¸‚æ”¿åºœå…¬é–‹è³‡æ–™ (æ¯ 60 ç§’æ›´æ–°)</p>
        </div>
        <div id="status-area" class="text-sm bg-blue-700 px-3 py-1 rounded-full">
            <span id="loader" class="refresh-loader mr-2 hidden"></span>
            <span id="update-time">åˆå§‹åŒ–ä¸­...</span>
        </div>
    </header>

    <div id="toast-container"></div>

    <main class="relative flex-grow">
        <div id="map"></div>

        <!-- å·¥å…·åˆ— -->
        <div class="absolute bottom-6 left-6 z-[1000] flex flex-col gap-2">
            <button onclick="locateUser()"
                class="bg-white p-3 rounded-full shadow-lg hover:bg-gray-50 transition-colors" title="å›åˆ°æˆ‘çš„ä½ç½®">
                ğŸ“
            </button>
        </div>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // è¨­å®š API ç¶²å€
        const API_URL = "https://api.kcg.gov.tw/Api/Service/Get/aaf4ce4b-4ca8-43de-bfaf-6dc97e89cac0";

        let map;
        let truckMarkers = [];
        let userMarker;
        const defaultZoom = 15;
        const defaultCenter = [22.6273, 120.3014]; // é«˜é›„å¸‚ä¸­å¿ƒ

        // é¡¯ç¤ºæç¤ºè¨Šæ¯ (å–ä»£ alert)
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `${bgColor} text-white px-4 py-2 rounded shadow-lg mb-2 text-sm transition-opacity duration-500`;
            toast.innerText = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            map = L.map('map').setView(defaultCenter, defaultZoom);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // åŸ·è¡Œç¬¬ä¸€æ¬¡è³‡æ–™ç²å–
            fetchData();
            // å˜—è©¦å®šä½
            locateUser();

            // æ¯ 60 ç§’åŸ·è¡Œä¸€æ¬¡æ›´æ–°
            setInterval(fetchData, 60000);
        }

        // å–å¾—ä½¿ç”¨è€…ä½ç½®
        function locateUser() {
            if ("geolocation" in navigator) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(function (position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    if (userMarker) {
                        userMarker.setLatLng([lat, lng]);
                    } else {
                        const userIcon = L.divIcon({
                            html: '<div style="background-color: #3b82f6; width: 15px; height: 15px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>',
                            className: 'user-location-icon',
                            iconSize: [15, 15]
                        });
                        userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(map).bindPopup("æ‚¨çš„ç›®å‰ä½ç½®");
                    }
                    map.setView([lat, lng], defaultZoom);
                    showToast("å·²æˆåŠŸå®šä½åˆ°æ‚¨çš„ä½ç½®");
                }, function (error) {
                    let msg = "";
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            msg = "å®šä½å¤±æ•—ï¼šä½¿ç”¨è€…æ‹’çµ•æä¾›ä½ç½®ã€‚";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            msg = "å®šä½å¤±æ•—ï¼šä½ç½®è³‡è¨Šä¸å¯ç”¨ã€‚";
                            break;
                        case error.TIMEOUT:
                            msg = "å®šä½å¤±æ•—ï¼šè«‹æ±‚é€¾æ™‚ã€‚";
                            break;
                        default:
                            msg = "å®šä½å¤±æ•—ï¼šç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚";
                            break;
                    }
                    console.error(msg, error);
                    showToast(msg, 'error');
                }, options);
            } else {
                showToast("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½", 'error');
            }
        }

        // ç²å– API è³‡æ–™
        async function fetchData() {
            const loader = document.getElementById('loader');
            const updateTimeSpan = document.getElementById('update-time');

            loader.classList.remove('hidden');

            try {
                // ä½¿ç”¨å¿«å–æ¸…é™¤åƒæ•¸é¿å… API å¿«å–èˆŠè³‡æ–™
                const response = await fetch(`${API_URL}?_=${new Date().getTime()}`);
                const result = await response.json();

                if (result.success && result.data) {
                    updateMarkers(result.data);
                    const now = new Date();
                    updateTimeSpan.innerText = `æœ€å¾Œæ›´æ–°ï¼š${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                } else {
                    updateTimeSpan.innerText = "è³‡æ–™æ ¼å¼éŒ¯èª¤";
                }
            } catch (error) {
                console.error("ç²å–è³‡æ–™å¤±æ•—: ", error);
                updateTimeSpan.innerText = "æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
            } finally {
                loader.classList.add('hidden');
            }
        }

        // æ›´æ–°åœ°åœ–æ¨™è¨˜
        function updateMarkers(data) {
            // æ¸…é™¤ç¾æœ‰åƒåœ¾è»Šæ¨™è¨˜
            truckMarkers.forEach(m => map.removeLayer(m));
            truckMarkers = [];

            data.forEach(truck => {
                const lat = parseFloat(truck.y || truck.Latitude);
                const lng = parseFloat(truck.x || truck.Longitude);
                const carNumber = truck.car || truck.CarNumber || "æœªçŸ¥è»Šè™Ÿ";
                const time = truck.time || truck.UpdateDate || "æœªçŸ¥æ™‚é–“";

                if (!isNaN(lat) && !isNaN(lng)) {
                    const truckIcon = L.divIcon({
                        html: `<div class="text-2xl" style="filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.5));">ğŸšš</div>`,
                        className: 'custom-truck-icon',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    const marker = L.marker([lat, lng], { icon: truckIcon })
                        .addTo(map)
                        .bindPopup(`
                            <div class="p-1">
                                <b class="text-lg">è»Šè™Ÿï¼š${carNumber}</b><br>
                                <hr class="my-1">
                                <span class="text-gray-600 text-sm">æ›´æ–°æ™‚é–“ï¼š${time}</span>
                            </div>
                        `);

                    truckMarkers.push(marker);
                }
            });
        }

        // åˆå§‹åŒ–
        window.onload = initMap;

    </script>
</body>

</html>